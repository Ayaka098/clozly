# AGENT.md — Clozly（思想・背景・仕様・実装判断を含む完全版）

> このドキュメントは、Clozlyを実装するエージェント（Codex等）が  
> **プロダクトの思想・意思決定の背景・具体仕様・実装優先順位・失敗時の分岐**まで含めて把握し、  
> これだけ読めば実装に入れる状態にするための「設計の憲法」である。  
>
> 重要：ここで定める思想と体験を損ねる妥協（例：ユーザーにスクショを強いる等）は、MVPであっても採用しない。

---

## 0. 一番大事な前提（思想の源泉）
### 0-1. Clozlyは「アプリを使わせる」ものではない
ユーザーは「アプリを完成させたい」のではない。  
ユーザーが欲しいのは「服」だ。  
つまり、ユーザーの目的は **服を納得して選ぶこと**であり、UI操作や学習はノイズである。

### 0-2. 提供したい体験（プロダクトの真髄）
Clozlyが提供するのは、機能ではなく体験である。

- 服選びを「面倒なものではない」と感じてもらう
- 失敗しない（買って後悔しない確率を下げる）
- 納得できる（“これでいい”ではなく“これがいい”を作る）
- そのために、検索や比較の負担をユーザーから取り除く

**すべての機能は上記体験のために存在する。**

### 0-3. 少数候補（4点）にこだわる理由
- 候補が多いほど、ユーザーは「選べない」に戻る
- 4点は「ちゃんと見れる」最小単位であり、迷いを増やさない
- 4点しか出さないからこそ、Clozlyは「検索の代替」ではなく「判断の代行」になる必要がある

### 0-4. 「上位4件」ではClozlyに価値が無いという重要な気づき
Amazon/ZOZOで同じ検索をして上位4件を出すだけなら、Clozlyは不要である。  
Clozlyの価値は「検索」ではなく **検索結果の編集（解釈）**にある。

- Amazon/ZOZO：条件に合う商品を大量に並べる
- Clozly：その人にとって意味がある4件に編集し、選択を引き受ける

この差分が出ない実装は採用しない。

---

## 1. 運用方針（規模・公開・規約の現実）
### 1-1. クローズド運用
- 公には公開しない
- 利用者は最大でも「自分＋彼＋友人5人」程度
- SNS等での公開は禁止

### 1-2. スクレイピング採用の背景
本来、ECサイトのデータ取得は規約的なグレーやブロックのリスクがある。  
しかし本プロジェクトは以下を前提に「体験優先」で採用する。

- 公開・商用スケールを前提にしない
- ユーザーにスクショ等の作業を強いない（体験破壊のためNG）
- 画像付きで少数候補を提示するには、現実的にスクレイピングが最短である

**ただし以下は絶対にしない：**
- ログイン必須ページの取得
- 購入フロー（カート/決済）の再現
- 公式と誤認されるUI（ブランド偽装）
- 大量アクセス・負荷をかける取得

---

## 2. プロダクトの全体像（ユーザー体験フロー）
### 2-1. 初回セットアップ（最短で）
1. Googleログイン
2. プロフィール入力（わかる範囲でOK）
   - 身長/体重/普段サイズ/体型傾向（任意）
3. 全身画像アップロード（後から更新可）
   - これは「試着イメージ生成」を楽にするため（写真アプリから探す手間を消す）

### 2-2. 毎回の利用フロー（最重要）
1. 欲しい服を自由記述で入力
2. 追加条件をボタンで選ぶ（絞り込み）
3. Clozlyが4件の候補を「画像付きカード」で提示
4. ユーザーはClozly内で4件から選ぶ（選択体験の完結）
5. 購入は外部リンク（Amazon/ZOZO）に移動（買う＝外）
6. 試着イメージが欲しい場合：
   - Clozlyがプロンプト生成
   - 全身画像をワンタップでコピー/ダウンロード
   - Gemini（Nano Banana）に貼り付けて生成（ユーザー自身のGoogleアカウントで実行）

---

## 3. 仕様（確定）
### 3-1. 提案単位・候補数
- 提案は単品のみ（MVP）
- 候補数は毎回4点

### 3-2. 毎回の入力項目
#### 必須
- 自由記述（欲しい服の説明）
- アイテム種別（トップス/アウター/ボトムス等）
- 予算（スライダー：下限/上限）

#### 任意（可能なら選ばせる）
- 季節
- 色
- 素材/雰囲気（例：きれいめ/カジュアル/ゆるめ/オフィス 等）

※ 任意を増やす理由：候補が4点しかないため、絞り込み情報は「精度のため」に必要。

### 3-3. スクレイピングで取得するデータ
#### 必須（カード表示に必要）
- 画像URL（サムネ）
- 商品名
- 価格
- 商品ページURL

#### 任意（ユーザー指定時に判断材料に使う）
- ブランド名
- 素材/説明の一部
- セール情報 等

### 3-4. 画像表示
- `<img src="imageUrl">`でClozly内表示
- 画像取得失敗時：
  - リンクのみ表示
  - 「画像を取得できませんでした」と明示

### 3-5. サイズ提案
- 表示形式：例「サイズ予測：M」
- 断定しない
- 常に「購入前に公式サイズ表で確認」を明示
- ブランド差の学習はMVPでは行わない（注意書きで担保）

### 3-6. 生成画像（Nano Banana）
- Clozlyは画像生成をしない（ユーザーのGoogleでGemini/Nano Bananaを使用）
- Clozlyはプロンプトテンプレートを生成
- 全身画像はClozlyに保持し、毎回探させない
- 背景変更はMVPではしない（精度低下リスク）
- 生成画像はClozly側で保存しない（運営が見えない設計）

---

## 4. Clozlyの価値を成立させるロジック（方法1〜3統合）
> ここがClozlyの心臓。  
> 「検索結果の上位4件」ではなく「その人にとっての4件」を作る。

### 4-1. 方法1：複数クエリで候補プールを作る
#### 目的
- 単一クエリの偏りを消す
- 言い換え・同義語で候補を広げる
- 「公式検索とは違う結果」にする

#### 実装
- 入力（自由記述＋ボタン）から検索クエリを3〜6本生成
- 例：トップス/白/きれいめ
  - 「白 トップス きれいめ」
  - 「白 ブラウス シンプル」
  - 「白 カットソー オフィス」
  - 「白 ニット きれいめ」 など

- 各クエリごとにAmazon/ZOZOの検索URLを生成し、一覧ページの上位10件を収集

### 4-2. 方法2：除外で「ハズレ」を消す
#### 固定NGワード（例）
- 福袋 / まとめ売り / 訳あり / セット / 在庫処分 等

#### ユーザーNG
- 色、素材、雰囲気、形など（入力UIで指定可能にする）

#### 予算レンジ外
- スクレイピングで取れた価格がレンジ外なら即除外

### 4-3. 方法3：スコアリングで「刺さる」を選ぶ
#### 基本思想
- “必須一致”は強い加点
- “自由記述での意図”は加点
- “NGに近い”は減点
- 4件は「バリエーションがある」方が良い（似すぎ回避）

#### MVPスコア例（0〜100の想定）
- 種別一致：+30（必須）
- 予算一致：+20（必須）
- 色一致：+10（指定があれば）
- 季節/素材一致：+10（指定があれば）
- 自由記述キーワード一致：+0〜20
- NGワード含む：-100（除外でも可）
- 価格がレンジ中央に近い：+0〜5（微調整）
- バリエーション（同じような商品が続く場合）：重複ペナルティ

#### バリエーション制御（似すぎ回避）
- 商品名・ブランド・画像URL・カテゴリ等が似すぎるものは減点
- 4件は「同じ白トップスでも雰囲気が少し違う」程度の幅を持たせる

---

## 5. キャッシュ（無料運用・安定運用の核）
### 5-1. なぜ必要か
複数クエリ×複数サイトのスクレイピングは、無料枠でも回数が増えると不安定になりやすい。  
キャッシュで回数を減らし、安定させる。

### 5-2. キャッシュ方針
- Supabaseに検索結果をキャッシュ
- TTL：6〜24時間（初期は12時間）
- 同条件はキャッシュを返す

### 5-3. キャッシュキー
- site（amazon|zozo）
- itemType
- budgetMin/budgetMax（帯に丸めるのも可）
- season
- color
- material/style
- freeTextNormalized（正規化・要約）

---

## 6. インフラ構成（無料・安定）
### 6-1. 採用構成
- Vercel（Next.js）：UI/認証/アプリAPI（スクレイピング以外）
- Supabase：ユーザーデータ・キャッシュ
- Cloudflare Workers：スクレイピング専用API

### 6-2. この構成の思想
- スクレイピングは外部HTTP取得が多く、タイムアウト/制限に当たりやすい
- Workersに切り出すと安定しやすい
- 7人規模なら無料枠中心で十分成立

---

## 7. 認証・データ
### 7-1. 認証
- Googleログインのみ
- 次回以降は自動ログイン（体験を損ねない）

### 7-2. 保存するデータ（最小）
- user
  - googleId
  - profile（身長/体重/サイズ/体型傾向）
- preferences
  - 好み（初回質問など、今後拡張）
- cache
  - 検索結果（4件候補ではなく、候補プールやスコアも含む）

### 7-3. 全身画像
- サーバーに保存しない（運営が見えない設計）
- ブラウザローカル（IndexedDB等）に保存
- プロンプト画面で常時表示
- 「画像コピー」「画像ダウンロード」を用意

---

## 8. 実装優先順位（迷ったらここに従う）
### Phase 1（最短で価値を出す）
1. Googleログイン
2. 入力UI（自由記述＋ボタン）
3. Workersでスクレイピング（一覧取得→候補プール）
4. 除外＋スコアリング＋4件表示（画像付きカード）
5. 購入リンク（外部へ）

### Phase 2（精度と安定）
6. キャッシュ（Supabase）
7. クエリ生成の改善（3〜6本の多様化）
8. 似すぎ回避（バリエーション制御）

### Phase 3（試着導線）
9. 全身画像のローカル保存
10. Nano Banana向けプロンプト生成
11. 画像コピー/ダウンロード導線

---

## 9. 絶対にやらないこと（禁止事項）
- ユーザーにスクショを撮らせる（体験破壊）
- 外部サイトをiframeで埋め込む（基本不可・体験も不安定）
- ログイン必須ページの取得
- カート/決済の再現
- 公式と誤認されるUI
- 大量アクセスで相手サイトに負荷をかける

---

## 10. 仕様変更の判断基準（思想に沿うか）
仕様を追加・変更するときは、必ず以下に照らす：

- ユーザーの手間が減るか？
- 迷いが減るか？
- 4点の納得感が上がるか？
- 「検索の代替」ではなく「判断の代行」になっているか？

YESが多い変更だけ採用する。

---

## 実装メモ
### 追加で実装したもの
- Next.js App Router 構成のUI一式（入力/4件表示/プロフィール/全身画像/プロンプト）
- Googleログインの雛形（NextAuth + Google Provider）
- クエリ生成、除外、スコアリング、バリエーション制御
- Supabaseキャッシュ（未設定時はメモリキャッシュでフォールバック）
- Cloudflare WorkersでのAmazon/ZOZOスクレイピング雛形
- 全身画像のIndexedDB保存とプロンプト生成
- 開発用の基盤ファイル（`package.json`, `tsconfig.json`, `next.config.js`, `.env.example`）
- Supabaseキャッシュ用のSQL（`supabase/schema.sql`）
- 上部タブナビ（服を探す/基本情報/アカウント）と右上アカウント丸アイコンUI
- 白基調＋ブラウンアクセントのデザイン調整
- 「Curated 4」タグを削除し、本文フォントを読みやすいものへ変更（ロゴは維持）
- UIをページ分割（/search, /quiz, /basic, /account）し、上部stickyヘッダーを共通化
- 探すページを入力＋4件カードのみに整理（診断/基本情報/説明文を分離）
- タブのhover/active/選択中表現とモバイル対応を追加
- タブをiOSセグメント風に均等幅（3分割）配置し、button要素で遷移
- タブを固定幅（タイプ診断が収まる最小幅）に統一し、ロゴ近くに左寄せ配置
- ロゴ文字サイズを1.2倍に拡大
- ロゴ文字サイズをさらに1.5倍に拡大（合計で大きめに調整）
- 予算レンジを100〜20000円に変更し、上限最大時は「上限なし」扱いに
- 季節を複数選択可能に変更（配列で保持・検索/スコア/キャッシュ対応）
- 色と素材も複数選択可能に変更（OR判定で検索/スコア/キャッシュ対応）
- 検索ボタン文言を「探す」に変更
- 予算スライダーのつまみ位置とバーのズレを修正
- READMEを詳細に更新（絵文字入りで概要/構成/セットアップを記載）
- `app/api/search/route.ts` のitemTypeを厳格化（Zod enum）して型エラー修正
- `app/api/search/route.ts` で `parsed.data` を `SearchRequest` に明示し、型エラーを再発防止
- `z.enum` の定義を `as const` 配列に変更してビルドエラーを修正
- `components/AppClient.tsx` の初期値を配列型（season/color/material）に修正
- `components/AppClient.tsx` の入力欄を配列対応に修正（カンマ区切り）
- `tsconfig.json` に `baseUrl` を追加して非相対パスの型エラーを修正
- `components/AuthBar.tsx`のJSX文字列エスケープを修正（ビルドエラー対応）
- タブを画面左右いっぱいに伸ばす（PC/スマホ共通）
- タブバーは全幅にしつつ、タブの幅は固定のままに調整
- ヘッダー背景（白い帯）を左右いっぱいに広げるため、topbarを全幅にして内側に幅制限を移動
- トップページにスプラッシュアニメーション（ロゴ中央＋Clozly横フェードイン、サーモンピンク〜ブラウン背景）を追加
- トップページ表示から2秒後に`/search`へ自動遷移する処理を追加
- スプラッシュ背景をより明るいピンク寄りのブラウンへ調整
- スプラッシュ背景色を`#debecc`に変更
- スプラッシュ背景色を`#debecc`基準のグラデーションに変更
- スプラッシュ背景のベースを`#fbdac8`に調整
- スプラッシュ背景のベースを`#e9dacb`に変更
- スプラッシュのロゴを画像`/Clozly_ロゴ_ハンガーのみ.png`に差し替え
- スプラッシュロゴ画像の表示サイズを4倍に拡大
- スプラッシュの「Clozly」文字をロゴと同系のセリフ（Fraunces）に変更
- ヘッダーのロゴにハンガーのみの画像を追加（文字ロゴの左に配置）
- ヘッダーのハンガーロゴ画像サイズを1.5倍（44px→66px）に調整
- ロゴとタブの間隔を少し広げる（topbar-leftのgapを24pxに調整）
- ブラウザタブのタイトルを設定し、メタディスクリプション/OGP説明文を更新
- ファビコンを文字入りロゴ画像に変更（`/Clozly_ロゴ_文字入り.png`）
- メタディスクリプション/OGP説明文から「4点」の表現を削除
- Rakuten Ichiba APIの候補取得を追加し、検索APIで最優先に利用するよう更新（`RAKUTEN_APPLICATION_ID`対応）
- 検索APIはRakutenのみを使用する構成に変更（Amazon/ZozoスクレイピングはMVPで未使用）
- キャッシュキーを並び順に依存しないよう正規化し、予算帯の丸め幅を拡大してヒット率を改善
- スコアリングにブランド/説明文を含め、アイテム種別のヒント語で加点するよう改善
- README.mdをRakuten API中心の仕様に更新（環境変数・検索ロジック・注意点を修正）
- Push Protectionで`.env.local`がブロックされたため、秘密情報を含むコミットを履歴から削除して対応（`develop`先頭コミットは`966f8ac`）
- 「基本情報」タブ/ページを削除し、プロフィール入力をアカウントページへ統合
- モバイル時のタブ崩れを防ぐため、タブ幅を可変＆折り返し対応に調整
- タブバーの高さを約80%に圧縮（タブ自体のサイズは維持）
- タブ列のみ上下余白を詰め、ロゴ周りは据え置きのままタブバー高さをさらに圧縮
- Rakuten APIは1回取得＋条件不足時のみ救済2回目の運用ルールを実装（クエリ設計/救済/不足時メッセージ）
- 検索クールダウン（10秒）と軽い不足表示をUIに追加
- キャッシュキーの正規化（NFKC/小文字化/配列ソート）を強化
- 商品画像を`loading="lazy"`で軽量化
- 検索条件にメンズ/レディース指定を追加（UI・API・クエリ・キャッシュ対応）
- /search 画面にもメンズ/レディース指定のUIを追加
- メンズ/レディースの初期選択を「指定なし」に変更
- スプラッシュ画面のロゴ/タイトルを少し左寄せに調整
- 自由記述とプロンプトの初期値を空に変更
- 自由記述欄に例のプレースホルダーを追加
- 検索結果が不足した際に条件過多の可能性を明示する注意文を追加
- 検索ボタンにスピナー（処理中表示）を追加
- Rakuten画像URLを高解像度指定（_ex=800x800）に変換して画質改善
- 検索入力と検索結果を別ページに分離（/search → /results）
- 結果ページに再検索/戻る/試着ボタンを追加（試着はアカウントのプロンプトへ遷移）
- 検索失敗時の文言を「検索結果がありませんでした」に変更
- 結果画面の見出しを「こちらはいかがでしょうか」に変更
- セカンダリボタンのホバー時コントラストを改善
- 未ログイン時のヘッダーを「ログイン」ボタン表示に変更
- アカウント画面の構成を基本情報→全身画像の2カラムに変更（モバイルは縦並び）
- 体型傾向の入力項目を削除
- ログアウトボタンを画面下部の赤色ボタンに変更
- 「試着」タブを追加し、プロンプト画面を別ページ（/tryon）に分離
- 基本情報に「好みのサイズ感」「雰囲気」チップを追加
- 試着ページの「画像をダウンロード」を「画像をコピー」に変更（クリップボード対応）
- ログアウトボタンの白いカード枠を削除
- ログイン後のヘッダー表示を「マイページ」タブ風デザインに変更
- 未ログイン時のGoogleログインボタンを円形・中央配置に変更
- 未ログイン時ログイン画面のカード枠を削除
- Googleログインボタンをハンガーロゴ形状に変更（ロゴ内に文字配置）
- Googleログイン文字位置をハンガー空白に合わせて調整
- Googleログインをハンガー下配置に変更し、白い枠で囲むよう調整
- ハンガーと文字が一体に見えるようログインボタン全体の枠と背景を強化

### 現状まとめ（最新状態）
- 商品取得はRakuten Ichiba APIのみを使用（Amazon/ZozoスクレイピングはMVPで未使用）
- Rakuten App IDが未設定の場合はモック候補を返す設計
- 4件候補はRakuten APIから取得できる状態を確認済み（画像/リンク遷移OK）
- キャッシュキーは配列順序非依存＋予算帯の丸めでヒット率を上げている
- スコアリングは商品名＋ブランド＋説明文を含むテキストで評価

### まだ未実施（あなたの作業が必要）
- Vercel/Supabase/Cloudflare/Google OAuthの実アカウント設定
- SupabaseのDB作成と環境変数の投入
- Workersのデプロイと`WORKER_SCRAPE_URL`設定（スクレイピング運用に戻す場合のみ）
- `npm install`による依存関係のインストール

### 注意点
- スクレイピングはHTML構造依存のため、実運用前にセレクタ調整が必要
- Googleログインは環境変数未設定だと動作しない
- Supabase環境変数が未設定の場合はメモリキャッシュのみで動作
- Rakuten App IDが未設定の場合はモック商品を返す設計

### 動作確認の最短手順（未実施）
- `npm install`
- `.env.example`を元に`.env.local`作成（最低限`NEXTAUTH_SECRET`は設定）
- `npm run dev`

### 主要ファイルと役割
- `app/page.tsx`: 画面構成
- `components/AppClient.tsx`: 入力・検索・画像保存・プロンプト生成のロジック
- `app/api/search/route.ts`: 検索API（クエリ生成→Rakuten API→4件選定）
- `lib/scoring.ts`: スコアリング/除外/多様性制御
- `lib/rakuten.ts`: Rakuten Ichiba APIの取得・整形
- `workers/scrape/src/index.ts`: Workersスクレイピング実装
- `supabase/schema.sql`: キャッシュテーブル定義

### 運用ルール（継続）
- 今後、実装を行うたびに「実装メモ」を更新すること
- ユーザーから「更新してください」と指示があった場合は、その指示内容自体も実装メモに記載すること
- 新しい会話でもAGENTS.mdのみで前提共有できるよう、実装内容/未実施項目/理由を可能な限り詳記すること

### 指示ログ
- 「今後、何か実装をするたびにAGENT.mdの実装メモを更新していってください。更新してくださいと言う指示も実装メモに書いておいてください。」
- 「次の新しい会話に映ったときにすべての要件とか仕様、実装状況が伝わるようになっているかチェックし、不足があれば追加すること。」
- 「上の方にタブを用意し、いろんなページに行けるように（服を探す/基本情報/アカウント）。アカウントは右上の丸の見た目に。白基調＋おしゃれなブラウンの洗練デザイン。」
- 「Curated 4という表示は不要。ロゴ以外は読みやすいフォントに変更。」
- 「Clozly UI 再設計 指示：上部固定タブ/ページ分割/モバイルファースト/説明排除/タブの状態表現/白×ブラウンの洗練デザイン。」
- 「タブは画面左右いっぱいの長さに（スマホ/PC共通）。」
- 「タブの幅はそのままで、タブバーだけ全幅にしてほしい。」
- 「白い部分を左右いっぱいの長さにしてほしい。」
- 「タブバーは100vw。タブは3等分で同じ幅。button要素＋hover/active/selected。高さ44px以上。」
- 「タブは3等分ではなく最小幅で同一サイズにし、ロゴの右に寄せる。」
- 「ロゴの文字サイズを1.2倍にしてほしい。」
- 「さらに1.5倍にしてほしい。」
- 「金額バーを最小100円〜最大20000円にし、最大時は上限なし検索にする。」
- 「季節を複数選択できるようにしてほしい。」
- 「色も素材も複数選択できるようにし、検索時はどれかに一致すればOKに。」
- 「検索ボタンの文言を『探す』に変更。」
- 「金額スライドバーの●とバー位置のズレを修正。」
- 「README.mdを詳細に書いてほしい（絵文字込み）。」
- 「Vercelビルドの型エラー（itemTypeがstring）を修正してほしい。」
- 「マージ後も同じ型エラーが出るので修正してほしい。」
- 「z.enumの型エラーを直してほしい。」
- 「AppClientのseason/color/materialが配列でないためビルド失敗、修正してほしい。」
- 「AppClientのseason入力が配列型でないエラーを修正してほしい。」
- 「Non-relative paths are not allowed のビルドエラーを修正してほしい。」
- 「これまでの変遷と実装内容をAGENTS.mdとREADME.mdに書いてください。」
- 「これまでの流れを全部、必要なところ、現在に反映されているところをAGENTS.mdに記載してください。」
- 「基本情報タブをなくして、アカウントに統合してほしい。」
- 「Rakuten API 検索の運用ルール（速度優先・刺さる4件優先）を実装に反映してほしい。」
- 「メンズかレディースかを指定できるようにしてほしい。」
- 「/searchで指定できるようにしてほしい。」
